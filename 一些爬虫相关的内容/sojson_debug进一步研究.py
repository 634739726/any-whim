# 完全依赖 js2py

# 尝试通过某种方式实现对 sojson 的解压缩。目前还是半成品。
# 将 while+switch 打乱的执行流程恢复，并且通过一定方式将参数配置干净
# 希望后续能对若函数进行有效的降解。
script = r'''
    try {
        var _0x407b36 = '1|0|4|2|3'['split']('|'), _0x369aff = 0;
        while (!![]) {
            switch (_0x407b36[_0x369aff++]) {
            case '0':
                var _0x392d22 = document[_0x541a7f[0]];
                continue;
            case '1':
                var _0x541a7f = [
                    'domain',
                    'split',
                    'reverse',
                    'join',
                    'search',
                    'hr' + 'ef',
                    'random',
                    !0
                ];
                continue;
            case '2':
                var _0x503094 = function (_0x13366f, _0x5e3159) {
                    var _0x1d478e = {
                        'msSnD': '2|4|0|1|6|3|5',
                        'CxFBS': 'function *\\( *\\)',
                        'zwPIS': function _0xe370dc(_0x14ea45, _0x1eb747) {
                            return _0x14ea45(_0x1eb747);
                        },
                        'lzMRv': 'init',
                        'pdicj': function _0x1db8d0(_0x53b15c, _0x557390) {
                            return _0x53b15c + _0x557390;
                        },
                        'FxUPb': 'chain',
                        'kxCdl': 'input',
                        'KgFfr': function _0x41cf33(_0x16574f, _0x4386b7) {
                            return _0x16574f(_0x4386b7);
                        },
                        'XqRbH': function _0x3e8ea3(_0xeb9b0c, _0x25efed) {
                            return _0xeb9b0c === _0x25efed;
                        },
                        'qMQZG': 'sRP',
                        'UghsX': '3|5|0|4|6|1|2',
                        'ZDCqC': function _0x55383f(_0xefcda1) {
                            return _0xefcda1();
                        },
                        'nwGbm': function _0x90eda7(_0xb4372b, _0x18eb99, _0x3fe03a) {
                            return _0xb4372b(_0x18eb99, _0x3fe03a);
                        }
                    };
                    var _0x1e9135 = _0x1d478e['msSnD']['split']('|'), _0x39ecf8 = 0;
                    while (!![]) {
                        switch (_0x1e9135[_0x39ecf8++]) {
                        case '0':
                            (function () {
                                _0x355a8f['uHhKH'](_0x110b01, this, function () {
                                    var _0x4f42fc = new RegExp(_0x355a8f['dBcIy']);
                                    var _0x267075 = new RegExp('\\+\\+ *(?:_0x(?:[a-f0-9]){4,6}|(?:\\b|\\d)[a-z0-9]{1,4}(?:\\b|\\d))', 'i');
                                    var _0x3327d0 = _0x355a8f['NkQKH'](_0x9f5c32, _0x355a8f['KKVId']);
                                    if (!_0x4f42fc['test'](_0x355a8f['sivFS'](_0x3327d0, _0x355a8f['uDVug'])) || !_0x267075['test'](_0x355a8f['lChZe'](_0x3327d0, _0x355a8f['vCOSt']))) {
                                        _0x355a8f['dyZsl'](_0x3327d0, '0');
                                    } else {
                                        _0x9f5c32();
                                    }
                                })();
                            }());
                            continue;
                        case '1':
                            var _0x4cc49c = function () {
                                var _0x12fa7c = !![];
                                return function (_0x488afc, _0x5ab443) {
                                    var _0x17a201 = _0x12fa7c ? function () {
                                        var _0x4b08f9 = {
                                            'QorpD': function _0xab8642(_0x575440, _0x4fc3e0) {
                                                return _0x575440 !== _0x4fc3e0;
                                            },
                                            'CETWg': 'MWm',
                                            'TnkvU': function _0x4b74f2(_0x15dfa9, _0x2d0059) {
                                                return _0x15dfa9 === _0x2d0059;
                                            },
                                            'yXQXL': 'odF',
                                            'YZgLg': function _0x453b54(_0x4a62fb, _0x1667b6) {
                                                return _0x4a62fb(_0x1667b6);
                                            },
                                            'qEqwC': '._key',
                                            'chUrU': '[name=\'keys\']',
                                            'lIfgD': function _0x470122(_0x3f1c7d, _0x2c3de2) {
                                                return _0x3f1c7d(_0x2c3de2);
                                            },
                                            'EsOdj': '__key',
                                            'INedX': function _0x50aa82(_0x50a086, _0x2ffeba) {
                                                return _0x50a086 !== _0x2ffeba;
                                            }
                                        };
                                        if (_0x4b08f9['QorpD']('cLw', _0x4b08f9['CETWg'])) {
                                            if (_0x5ab443) {
                                                if (_0x4b08f9['TnkvU'](_0x4b08f9['yXQXL'], 'MGc')) {
                                                    _0x4b08f9['YZgLg']($, _0x4b08f9['qEqwC'])['find'](_0x4b08f9['chUrU'])['val'](keys[i]);
                                                    _0x4b08f9['lIfgD']($, _0x4b08f9['qEqwC'])['find']('[name=\'values\']')['val'](values[i]);
                                                    $(_0x4b08f9['qEqwC'])['removeClass']('_key')['addClass'](_0x4b08f9['EsOdj']);
                                                } else {
                                                    var _0x53d5cc = _0x5ab443['apply'](_0x488afc, arguments);
                                                    _0x5ab443 = null;
                                                    return _0x53d5cc;
                                                }
                                            }
                                        } else {
                                            text = $['trim'](text);
                                            if (_0x4b08f9['INedX'](text['indexOf']('\\u'), -1)) {
                                                text = GB2312UnicodeConverter['ToGB2312'](text);
                                            }
                                            text = jsl['format']['formatJson'](text);
                                        }
                                    } : function () {
                                        var _0x4aedc8 = {
                                            'LCjwh': function _0x7eea0c(_0x4107c4, _0x22b130) {
                                                return _0x4107c4 === _0x22b130;
                                            },
                                            'qkGuH': 'XaB',
                                            'kyLSh': function _0x1c4620(_0x421dcf, _0x2daab4) {
                                                return _0x421dcf(_0x2daab4);
                                            }
                                        };
                                        if (_0x4aedc8['LCjwh'](_0x4aedc8['qkGuH'], _0x4aedc8['qkGuH'])) {
                                        } else {
                                            var _0x2e0139 = _0x4aedc8['kyLSh']($, thiz), _0x29d76e = $(_0x29d76e);
                                            return thiz['checked'] ? _0x29d76e['show'](300) : _0x29d76e['hide'](300), !1;
                                        }
                                    };
                                    _0x12fa7c = ![];
                                    return _0x17a201;
                                };
                            }();
                            continue;
                        case '2':
                            var _0x355a8f = {
                                'dBcIy': _0x1d478e['CxFBS'],
                                'NkQKH': function _0x2343bd(_0x21fce5, _0x4a2125) {
                                    return _0x1d478e['zwPIS'](_0x21fce5, _0x4a2125);
                                },
                                'KKVId': _0x1d478e['lzMRv'],
                                'sivFS': function _0x431e03(_0xc5a6ef, _0x31d238) {
                                    return _0x1d478e['pdicj'](_0xc5a6ef, _0x31d238);
                                },
                                'uDVug': _0x1d478e['FxUPb'],
                                'lChZe': function _0x347131(_0x4a0064, _0x561d89) {
                                    return _0x1d478e['pdicj'](_0x4a0064, _0x561d89);
                                },
                                'vCOSt': _0x1d478e['kxCdl'],
                                'dyZsl': function _0xfa3eb(_0x9876f3, _0x197009) {
                                    return _0x1d478e['KgFfr'](_0x9876f3, _0x197009);
                                },
                                'uHhKH': function _0x61424(_0x4173d0, _0x3f6907, _0x2b5996) {
                                    return _0x4173d0(_0x3f6907, _0x2b5996);
                                },
                                'ndJVV': 'undefined',
                                'YQnQj': function _0x5a3043(_0x2fcece, _0x52d7ef) {
                                    return _0x1d478e['XqRbH'](_0x2fcece, _0x52d7ef);
                                },
                                'KROyr': 'object',
                                'ncLjs': 'function',
                                'ABOGf': function _0x2c2d87(_0x50d158, _0x3c79e8) {
                                    return _0x50d158 === _0x3c79e8;
                                },
                                'XnwZq': _0x1d478e['qMQZG'],
                                'TEWaV': 'old_',
                                'HIjFa': _0x1d478e['UghsX']
                            };
                            continue;
                        case '3':
                            _0x1d478e['ZDCqC'](_0x4ab988);
                            continue;
                        case '4':
                            var _0x110b01 = function () {
                                var _0x3d4bfb = !![];
                                return function (_0x33e0ed, _0x263131) {
                                    var _0x1a3d75 = _0x3d4bfb ? function () {
                                        var _0x19830f = {
                                            'ySSAo': 'zNE',
                                            'ljVJv': 'rwU',
                                            'aLYBb': 'VgD',
                                            'gOSCL': function _0xe9a64e(_0x3fe3ae, _0x15202f) {
                                                return _0x3fe3ae(_0x15202f);
                                            },
                                            'NoUiJ': function _0x10a64e(_0x5a6bd6, _0x4280e7) {
                                                return _0x5a6bd6 == _0x4280e7;
                                            },
                                            'lhKyl': '3|1|2|8|4|0|5|7|6'
                                        };
                                        if (_0x19830f['ySSAo'] === 'zNE') {
                                            if (_0x263131) {
                                                if (_0x19830f['ljVJv'] !== _0x19830f['aLYBb']) {
                                                    var _0x587f16 = _0x263131['apply'](_0x33e0ed, arguments);
                                                    _0x263131 = null;
                                                    return _0x587f16;
                                                } else {
                                                    var _0x586035 = $['trim'](_0x19830f['gOSCL']($, data[i])['val']());
                                                    if (_0x19830f['NoUiJ'](_0x586035, '')) {
                                                        return !1;
                                                    }
                                                    outArray['push'](_0x586035);
                                                }
                                            }
                                        } else {
                                            var _0x569c64 = _0x19830f['lhKyl']['split']('|'), _0x679c30 = 0;
                                            while (!![]) {
                                                switch (_0x569c64[_0x679c30++]) {
                                                case '0':
                                                    _0x4a1b99['error'] = func;
                                                    continue;
                                                case '1':
                                                    _0x4a1b99['log'] = func;
                                                    continue;
                                                case '2':
                                                    _0x4a1b99['warn'] = func;
                                                    continue;
                                                case '3':
                                                    var _0x4a1b99 = {};
                                                    continue;
                                                case '4':
                                                    _0x4a1b99['info'] = func;
                                                    continue;
                                                case '5':
                                                    _0x4a1b99['exception'] = func;
                                                    continue;
                                                case '6':
                                                    return _0x4a1b99;
                                                case '7':
                                                    _0x4a1b99['trace'] = func;
                                                    continue;
                                                case '8':
                                                    _0x4a1b99['debug'] = func;
                                                    continue;
                                                }
                                                break;
                                            }
                                        }
                                    } : function () {
                                        var _0x2c4c8a = {
                                            'qvrMS': function _0x1dfe8d(_0x27442c, _0x2eb462) {
                                                return _0x27442c === _0x2eb462;
                                            },
                                            'NAhme': 'Rkq',
                                            'yjzQh': 'UwF',
                                            'IiJdx': '1|4|2|0|3',
                                            'YJSwL': function _0x13f558(_0x47ba90, _0x2a98b9) {
                                                return _0x47ba90(_0x2a98b9);
                                            },
                                            'ZQRFG': '#single_parameter   .del_btn',
                                            'fzUDZ': '[name=butchParameter]',
                                            'JWwhX': '#_submitType'
                                        };
                                        if (_0x2c4c8a['qvrMS'](_0x2c4c8a['NAhme'], _0x2c4c8a['yjzQh'])) {
                                            var _0x4cb496 = _0x2c4c8a['IiJdx']['split']('|'), _0x54fdc7 = 0;
                                            while (!![]) {
                                                switch (_0x4cb496[_0x54fdc7++]) {
                                                case '0':
                                                    _0x2c4c8a['YJSwL']($, _show)['show'](100);
                                                    continue;
                                                case '1':
                                                    submitType = flag;
                                                    continue;
                                                case '2':
                                                    _0x2c4c8a['YJSwL']($, _hide)['hide']();
                                                    continue;
                                                case '3':
                                                    if (submitType == 1) {
                                                        $(_0x2c4c8a['ZQRFG'])['click']();
                                                    } else {
                                                        $(_0x2c4c8a['fzUDZ'])['val']('');
                                                    }
                                                    continue;
                                                case '4':
                                                    _0x2c4c8a['YJSwL']($, _0x2c4c8a['JWwhX'])['val'](flag);
                                                    continue;
                                                }
                                                break;
                                            }
                                        } else {
                                        }
                                    };
                                    _0x3d4bfb = ![];
                                    return _0x1a3d75;
                                };
                            }();
                            continue;
                        case '5':
                            return _0x1d478e['XqRbH'](_0x3adf46(_0x13366f)[_0x541a7f[4]](_0x5e3159), 0);
                        case '6':
                            var _0x4ab988 = _0x1d478e['nwGbm'](_0x4cc49c, this, function () {
                                var _0x555c99 = function () {
                                    var _0xc2319a = {
                                        'cTnyA': 'Adb',
                                        'GUDug': function _0x576379(_0x4fd878, _0x218feb) {
                                            return _0x4fd878(_0x218feb);
                                        },
                                        'GQFIG': '#xlist',
                                        'DlOPB': function _0x4efdb4(_0x1e5afc, _0x5777dc) {
                                            return _0x1e5afc(_0x5777dc);
                                        },
                                        'XVXeI': '.showBox',
                                        'mroDj': 'mousemove'
                                    };
                                    if (_0xc2319a['cTnyA'] !== _0xc2319a['cTnyA']) {
                                        _0xc2319a['GUDug']($, _0xc2319a['GQFIG'])['html'](html['join'](''));
                                        var _0x5433d3 = _0xc2319a['DlOPB']($, _0xc2319a['XVXeI']);
                                        $(document)['on'](_0xc2319a['mroDj'], function (_0x35d198) {
                                            var MrkLgh = {
                                                'Fachl': function _0x474eb9(_0x3948ce, _0x243b89) {
                                                    return _0x3948ce(_0x243b89);
                                                },
                                                'URzax': '#showBox',
                                                'KSVIu': function _0xd217af(_0x428b75, _0x3e468d) {
                                                    return _0x428b75(_0x3e468d);
                                                }
                                            };
                                            var _0xd8079d = MrkLgh['Fachl'](so, _0x35d198['target']);
                                            if (!(_0xd8079d['is'](_0x5433d3) || $('#showBox')['is'](_0xd8079d) || $(MrkLgh['URzax'])['find'](_0xd8079d)['length'])) {
                                                MrkLgh['KSVIu']($, MrkLgh['URzax'])['hide'](200);
                                                $(document)['unbind']('mousemove');
                                            }
                                        });
                                    } else {
                                    }
                                };
                                var _0x55b00c = typeof window !== _0x355a8f['ndJVV'] ? window : _0x355a8f['YQnQj'](typeof process, _0x355a8f['KROyr']) && typeof require === _0x355a8f['ncLjs'] && _0x355a8f['ABOGf'](typeof global, 'object') ? global : this;
                                if (!_0x55b00c['console']) {
                                    if (_0x355a8f['ABOGf'](_0x355a8f['XnwZq'], 'lcr')) {
                                        k = _0x355a8f['ABOGf'](k['indexOf'](_0x355a8f['TEWaV']), 0) ? k : getCharcode(k);
                                        console['log'](k, localStorage['removeItem'](k));
                                    } else {
                                        _0x55b00c['console'] = function (_0x26d574) {
                                            var _0x13d084 = { 'dXVpv': '8|4|5|1|2|6|3|0|7' };
                                            var _0x3fae8f = _0x13d084['dXVpv']['split']('|'), _0x17491a = 0;
                                            while (!![]) {
                                                switch (_0x3fae8f[_0x17491a++]) {
                                                case '0':
                                                    _0x99a535['trace'] = _0x26d574;
                                                    continue;
                                                case '1':
                                                    _0x99a535['debug'] = _0x26d574;
                                                    continue;
                                                case '2':
                                                    _0x99a535['info'] = _0x26d574;
                                                    continue;
                                                case '3':
                                                    _0x99a535['exception'] = _0x26d574;
                                                    continue;
                                                case '4':
                                                    _0x99a535['log'] = _0x26d574;
                                                    continue;
                                                case '5':
                                                    _0x99a535['warn'] = _0x26d574;
                                                    continue;
                                                case '6':
                                                    _0x99a535['error'] = _0x26d574;
                                                    continue;
                                                case '7':
                                                    return _0x99a535;
                                                case '8':
                                                    var _0x99a535 = {};
                                                    continue;
                                                }
                                                break;
                                            }
                                        }(_0x555c99);
                                    }
                                } else {
                                    var _0xc587b1 = _0x355a8f['HIjFa']['split']('|'), _0x241cec = 0;
                                    while (!![]) {
                                        switch (_0xc587b1[_0x241cec++]) {
                                        case '0':
                                            _0x55b00c['console']['debug'] = _0x555c99;
                                            continue;
                                        case '1':
                                            _0x55b00c['console']['exception'] = _0x555c99;
                                            continue;
                                        case '2':
                                            _0x55b00c['console']['trace'] = _0x555c99;
                                            continue;
                                        case '3':
                                            _0x55b00c['console']['log'] = _0x555c99;
                                            continue;
                                        case '4':
                                            _0x55b00c['console']['info'] = _0x555c99;
                                            continue;
                                        case '5':
                                            _0x55b00c['console']['warn'] = _0x555c99;
                                            continue;
                                        case '6':
                                            _0x55b00c['console']['error'] = _0x555c99;
                                            continue;
                                        }
                                        break;
                                    }
                                }
                            });
                            continue;
                        }
                        break;
                    }
                };
                continue;
            case '3':
                if (!_0x503094(_0x392d22, 'moc.nosjos')) {
                    while (_0x541a7f[7]) {
                        location[_0x541a7f[5]] = location[_0x541a7f[5]] + '?' + Math[_0x541a7f[6]]();
                    }
                }
                continue;
            case '4':
                var _0x3adf46 = function (_0x30a712) {
                    return _0x30a712[_0x541a7f[1]]('')[_0x541a7f[2]]()[_0x541a7f[3]]('');
                };
                continue;
            }
            break;
        }
    } catch (_0x59ca51) {
        console['log'](_0x59ca51);
    }
'''




def cover_undefined_null(node):
    # 如果不使用 js2py 内部的数据结构来包装一下这类的数据，反编译回 js 代码时就会出现问题。
    if node.get('raw') == 'null' and node.get('value', '') is None:
        node['value'] = JS_BUILTINS['null']
    elif node.get('raw') == 'undefined' and node.get('undefined', '') is None:
        node['value'] = JS_BUILTINS['undefined']

def convenience_tree(tree, pack=None):
    if pack is None:
        pack = ['body']
    if isinstance(tree, dict):
        cover_undefined_null(tree)
        for key in tree:
            if isinstance(tree[key], dict):
                node = cover_func(tree[key], parent_body=tree, curr_key=key)
                if node:
                    tree[key] = node
                else:
                    convenience_tree(tree[key])
            elif isinstance(tree[key], list):
                for idx, _tree in enumerate(tree[key]):
                    node = cover_func(tree[key][idx], parent_body=tree, curr_key=key,curr_idx=idx)
                    if node:
                        tree[key][idx] = node
                    else:
                        convenience_tree(_tree)

def get_script_from_tree(tree):
    import js2py.py_node_modules.escodegen as escodegen
    escodegen = escodegen.var.get('escodegen')
    generate = escodegen.get('generate')
    return generate(tree).to_python()

packer = []
def cover_func(node, parent_body=None, curr_key=None, curr_idx=None):
    if node.get('type'):
        packer.append([node, parent_body, curr_key, curr_idx])
    else:
        print('notype =========================', node)

def remake_while_statement(node, parent_body, curr_key, curr_idx):
    try:
        if js2py.eval_js(get_script_from_tree(node['test'])) == True:
            inblocks = node['body']['body']
            if isinstance(inblocks, list) and inblocks:
                firstone = parent_body['body'][curr_idx-1]
                switchone = [i for i in inblocks if i['type'] == 'SwitchStatement']
                lastone = [i for i in inblocks if i['type'] != 'EmptyStatement'][-1]
                if switchone and lastone['type'] == 'BreakStatement':
                    switchone = switchone[0]
                    sort_str, sort_idx = None, None
                    for i in firstone['declarations']:
                        try:
                            var = js2py.eval_js(get_script_from_tree(i['init']))
                        except:
                            # print(i,'-=-=-=-=-=-=-=-=-=-=-=-=-=')
                            raise
                        if isinstance(var, int):
                            sort_idx = var
                        else:
                            sort_str = var.to_list()
                    if switchone['discriminant']['property']['operator'] == '++':
                        rplpack = [None] * len(sort_str)
                        for case in switchone['cases']:
                            cover_undefined_null(case)
                            rplpack[sort_str.index(case['test']['value'])] = case
                        rpllist = []
                        for case in rplpack:
                            for incas in case['consequent']:
                                if incas['type'] == 'ContinueStatement': break
                                rpllist.append(incas)
                        rpllist.append(lastone)
                        return rpllist
    except:
        import traceback
        print(traceback.format_exc())



import json
import pyjsparser
import js2py
from js2py.pyjs import JS_BUILTINS


scrip1t = r'''
if (1>1){
    
}else{
    var asdf = [1,'1'];
    var qq = asdf[0];
    var _0x355a8f = {
        'HIjFa': _0x1d478e['UghsX']
    };
    var _0x1d478e = {
        'UghsX': '3|5|0|4|6|1|2'
    };
    var _0xc587b1 = _0x355a8f['HIjFa']['split']('|'), _0x241cec = 0;
    while (!![]) {
        switch (_0xc587b1[_0x241cec++]) {
        case '0':
            _0x55b00c['console']['debug'] = _0x555c99;
            continue;
        case '1':
            _0x55b00c['console']['exception'] = _0x555c99;
            continue;
        case '2':
            _0x55b00c['console']['trace'] = _0x555c99;
            continue;
        case '3':
            _0x55b00c['console']['log'] = _0x555c99;
            continue;
        case '4':
            _0x55b00c['console']['info'] = _0x555c99;
            continue;
        case '5':
            _0x55b00c['console']['warn'] = _0x555c99;
            continue;
        case '6':
            _0x55b00c['console']['error'] = _0x555c99;
            continue;
        }
        break;
    }
    function some(a,b){
        return a+b;
    }
    some(_0x355a8f['HIjFa'], _0x1d478e['UghsX'])
}
'''


tree = pyjsparser.parse(script)
convenience_tree(tree)
hmaps = {}
lmaps = {}
# 这里先处理一些对象参数存储。
for node, parent_body, curr_key, curr_idx in packer:
    if node['type'] == 'ObjectExpression' and parent_body.get('type') == 'VariableDeclarator':
        hmaps[parent_body['id']['name']] = d = {}
        for key in node['properties']:
            d[key['key']['value']] = key['value']
    if node['type'] == 'ArrayExpression' and parent_body.get('type') == 'VariableDeclarator':
        lmaps[parent_body['id']['name']] = d = []
        for key in node['elements']:
            d.append(key)

def cover_list(node):
    if node['type'] == 'MemberExpression' and node['object'].get('name'):
        kname = node['object'].get('name')
        vname = node['property'].get('value')
        if kname in hmaps:
            if vname in hmaps[kname]:
                return hmaps[kname][vname]
    else:
        return node

# 处理对象参数的兑现。
for node, parent_body, curr_key, curr_idx in packer:
    if node['type'] == 'MemberExpression' and node['object'].get('name'):
        kname = node['object'].get('name')
        vname = node['property'].get('value')
        if kname in hmaps:
            if vname in hmaps[kname]:
                if curr_idx is None:
                    parent_body[curr_key] = cover_list(hmaps[kname][vname])
                else:
                    parent_body[curr_key][curr_idx] = cover_list(hmaps[kname][vname])
        if kname in lmaps:
            if isinstance(vname, (float,int)):
                parent_body[curr_key] = lmaps[kname][int(vname)]

# 这里处理循环顺序的重新整理的部分。
for node, parent_body, curr_key, curr_idx in packer:
    if node['type'] == 'WhileStatement':
        rpllist = remake_while_statement(node, parent_body, curr_key, curr_idx)
        if rpllist:
            node['body']['body'] = rpllist



v = get_script_from_tree(tree)
print(v)